### 1.创建关机脚本
首先，需要创建一个关机脚本`stopserver.sh`，该脚本将负责关闭所有的虚拟机并执行ESXi主机的关机操作，并将脚本添加执行权限。
```shell
#!/bin/bash

#暂停所有正在运行的虚拟机
setvm_spend(){
    # 获取所有虚拟机的列表和它们的状态
   vm_list=$(vim-cmd vmsvc/getallvms |awk '{print $1}')


  # 循环遍历每个VMID
  for vmid in $vm_list; do
    # 获取虚拟机的状态
    expr $vmid + 1 &> /dev/null
    if [ $? != 0 ] ; then
      continue
    fi
    vm_status=$(vim-cmd vmsvc/power.getstate $vmid |grep "Powered")
    # 如果虚拟机是开机状态，则挂起
    if [ "$vm_status" == "Powered on" ]; then
        echo "Suspending VM with ID: $vmid"
        vim-cmd vmsvc/power.suspend $vmid
    else
        echo "VM with ID: $vmid is not powered on. Skipping suspension."
    fi
  done
}
setvm_spend
#系统进入维护模式
esxcli system maintenanceMode set --enable yes

/sbin/poweroff 

```

### 2.设置定时任务
由于ESXi的shell命令行不支持cron命令，需要通过修改计划任务文件或创建一个在系统启动时运行的脚本来实现定时任务。如所述，可以在`/etc/rc.local.d/local.sh`文件中添加一行脚本来自动添加定时任务，并且需要将该脚本保存到重启后不会丢失的位置，如`/vmfs/volumes/datastore1`。
```shell
#杀掉已经存在的cron进程 
/bin/kill $(cat /var/run/crond.pid)

#add shutdown script to crontab(root)
#修改/var/spool/crontab/root文件，增加相应的执行配置
#待修改的内容包括：
# 45 17 * * * 执行的时间，与cron相同，注意是UTC时间需换算
#/vmfs/volumnes/datastore1/autoshutdown.sh执行脚本路径
#注意一定要保存到datastore1这样的重启不会丢失的位置
#/var/spool/cron/crontabs/root是root用户cron配置文件位置，一般不用修改
/bin/echo  '20  18  * * * /bin/sh /vmfs/volumes/datastore1/stopserver.sh ' >> /var/spool/cron/crontabs/root

#restart cron service
#重启cron进程（将加载修改后的root文件）
/usr/lib/vmware/busybox/bin/busybox crond
```


### 3.持久化设置
为了确保在ESXi重启后设置仍然有效，需要执行`/sbin/auto-backup.sh`脚本来保存修改后的配置文件，如所述。

### 4.立即生效
如果需要立即生效cron设定，可以执行`/etc/rc.local.d/local.sh`脚本来立即添加定时任务并重启cron进程。


<font color=Chocolate><strong>注意事项: </strong></font>在文中提到，ESXi重启后配置信息会自动丢失，因此需要确保脚本放置在数据存储目录下，如/vmfs/volumes/datastore1，以避免重启后丢失。>在文中提到，ESXi重启后配置信息会自动丢失，因此需要确保脚本放置在数据存储目录下，如/vmfs/volumes/datastore1，以避免重启后丢失。