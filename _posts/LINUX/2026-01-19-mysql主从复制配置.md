## mysql主从复制配置



#### 系统环境配置

##### 关闭selinux

**临时关闭**

```shell
 setenforce 0
```

**永久关闭，修改配置文件，设置`SELINUX=disabled`**

```shell
[root@localhost ~]# vi /etc/selinux/config 
# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
# See also:
# https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/changing-selinux-states-and-modes_using-selinux#changing-selinux-modes-at-boot-time_changing-selinux-states-and-modes
#
# NOTE: Up to RHEL 8 release included, SELINUX=disabledd would also
# fully disable SELinux during boot. If you need a system with SELinux
# fully disabled instead of SELinux running with no policy loaded, you
# need to pass selinux=0 to the kernel command line. You can use grubby
# to persistently set the bootloader to boot with selinux=0:
#
#    grubby --update-kernel ALL --args selinux=0
#
# To revert back to SELinux enabled:
#
#    grubby --update-kernel ALL --remove-args selinux
#
SELINUX=disabled
# SELINUXTYPE= can take one of these three values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected.
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted
```

**验证是否关闭**

```shell
[root@localhost ~]# getenforce 
Disabled
```

**配置hosts文件**

```shell
cat > /etc/hosts << EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.0.111  mysql-master
192.168.0.112  mysql-slave1
192.168.0.113  mysql-slave2
EOF
```

#### mysql主从服务器配置

**添加从服务器连接用户**

```sql
CREATE USER '连接账号slave'@'%' IDENTIFIED BY 'QianFeng@123';

ALTER USER '连接账号slave'@'%'
IDENTIFIED WITH mysql_native_password
BY '连接密码xxx';

FLUSH PRIVILEGES;
```

**主服务修改my.cnf配置文件，增加以下配置项**

```
log-error                       =/var/log/mysql/mysql.log
pid-file                        =/var/log/mysql/mysqld.pid
gtid_mode                       = ON
enforce_gtid_consistency        = 1
server-id                       = 1
```

**从服务器1配置文件增加以下配置项**

```
gtid_mode                       = ON
enforce_gtid_consistency        = 1
server-id                       = 2
master-info-repository          =TABLE
relay-log-info-repository       =TABLE
read_only                       =1
```

**从服务器2配置文件增加以下配置项**

```
gtid_mode                       = ON
enforce_gtid_consistency        = 1
server-id                       = 3
master-info-repository          =TABLE
relay-log-info-repository       =TABLE
read_only                       =1
```

**从服务器设置连接主服务器的信息**

```shell
CHANGE MASTER TO
MASTER_HOST='mysql-master',
MASTER_USER='连接账号slave',
MASTER_PASSWORD='连接密码xxx',
MASTER_AUTO_POSITION=1;
```

**重启主从服务器的mysql服务，三台都要执行**

```
systemctl restart mysqld
```

**查看主从状态,确定` Slave_IO_Running`和`Slave_SQL_Running`都为yes**

```
mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for source to send event
                  Master_Host: mysql-master
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000007
          Read_Master_Log_Pos: 647
               Relay_Log_File: localhost-relay-bin.000004
                Relay_Log_Pos: 863
        Relay_Master_Log_File: mysql-bin.000007
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 647
              Relay_Log_Space: 2511
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
                  Master_UUID: 9531b7aa-efd0-11f0-b4e5-000c29d16989
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Replica has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 9531b7aa-efd0-11f0-b4e5-000c29d16989:1-8
            Executed_Gtid_Set: 9531b7aa-efd0-11f0-b4e5-000c29d16989:1-8
                Auto_Position: 1
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
       Master_public_key_path: 
        Get_master_public_key: 0
            Network_Namespace: 
1 row in set, 1 warning (0.00 sec)
```




